import React, { useState, useEffect, useRef } from 'react';
import { 
  Star, 
  Palette, 
  BookOpen, 
  Home, 
  Check, 
  RefreshCw, 
  Sun, 
  Moon, 
  Trash2,
  Award,
  Music,
  Volume2,
  TrainFront, // æ–°å¢ç«è»Šåœ–ç¤º
  PlayCircle
} from 'lucide-react';

// --- çµ„ä»¶ï¼šä¸»é¸å–® ---
const MainMenu = ({ onNavigate }) => {
  return (
    <div className="flex flex-col items-center justify-center h-full space-y-6 p-4 animate-fade-in overflow-y-auto">
      <h1 className="text-4xl font-bold text-indigo-600 mb-4 tracking-wider text-center">
        å°æ˜Ÿæ˜Ÿæˆé•·æ¨‚åœ’
      </h1>
      <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 w-full max-w-4xl">
        <MenuCard 
          title="ç”Ÿæ´»å¥½ç¿’æ…£" 
          icon={<Star size={40} />} 
          color="bg-yellow-400" 
          onClick={() => onNavigate('habits')} 
        />
        <MenuCard 
          title="èªçŸ¥å¡ç‰‡" 
          icon={<BookOpen size={40} />} 
          color="bg-blue-400" 
          onClick={() => onNavigate('learn')} 
        />
        <MenuCard 
          title="å°å°ç•«å¸ƒ" 
          icon={<Palette size={40} />} 
          color="bg-pink-400" 
          onClick={() => onNavigate('draw')} 
        />
        <MenuCard 
          title="å™¹å™¹å°ç«è»Š" 
          icon={<TrainFront size={40} />} 
          color="bg-red-500" 
          onClick={() => onNavigate('train')} 
        />
      </div>
      <div className="mt-4 text-gray-400 text-sm">
        é©åˆ 3-5 æ­²å°æœ‹å‹çš„äº’å‹•ç¨‹å¼
      </div>
    </div>
  );
};

const MenuCard = ({ title, icon, color, onClick }) => (
  <button 
    onClick={onClick}
    className={`${color} text-white rounded-3xl p-6 flex flex-col items-center justify-center shadow-xl transform transition hover:scale-105 active:scale-95 border-4 border-white/30 w-full aspect-video sm:aspect-auto sm:h-40`}
  >
    <div className="mb-2 bg-white/20 p-3 rounded-full">
      {icon}
    </div>
    <span className="text-xl font-bold tracking-widest">{title}</span>
  </button>
);

// --- çµ„ä»¶ï¼šç”Ÿæ´»å¥½ç¿’æ…£ (é›†é»å¡) ---
const HabitTracker = () => {
  const [tasks, setTasks] = useState([
    { id: 1, name: 'åˆ·åˆ·ç‰™', icon: 'ğŸª¥', stars: 0, max: 5 },
    { id: 2, name: 'æ”¶ç©å…·', icon: 'ğŸ§¸', stars: 0, max: 5 },
    { id: 3, name: 'åƒé’èœ', icon: 'ğŸ¥¦', stars: 0, max: 5 },
    { id: 4, name: 'æº–æ™‚ç¡è¦º', icon: 'ğŸ›Œ', stars: 0, max: 5 },
  ]);

  const [showCelebration, setShowCelebration] = useState(false);

  const addStar = (id) => {
    setTasks(tasks.map(task => {
      if (task.id === id) {
        if (task.stars < task.max) {
          playSound('pop');
          if (task.stars + 1 === task.max) {
            playSound('cheer');
            setShowCelebration(true);
            setTimeout(() => setShowCelebration(false), 3000);
          }
          return { ...task, stars: task.stars + 1 };
        }
      }
      return task;
    }));
  };

  const resetTask = (id) => {
    if(window.confirm("ç¢ºå®šè¦é‡æ–°é–‹å§‹é€™å€‹ä»»å‹™å—ï¼Ÿ")) {
      setTasks(tasks.map(task => task.id === id ? { ...task, stars: 0 } : task));
    }
  };

  return (
    <div className="p-4 max-w-3xl mx-auto h-full overflow-y-auto pb-20">
      <h2 className="text-3xl font-bold text-yellow-600 text-center mb-6 bg-yellow-100 py-3 rounded-full shadow-sm">
        å¥½å¯¶å¯¶é›†é»å¡
      </h2>
      
      {showCelebration && (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 pointer-events-none">
          <div className="bg-white p-8 rounded-3xl animate-bounce text-center">
            <div className="text-6xl mb-4">ğŸ†</div>
            <div className="text-2xl font-bold text-yellow-500">å¤ªæ£’äº†ï¼å®Œæˆä»»å‹™ï¼</div>
          </div>
        </div>
      )}

      <div className="space-y-4">
        {tasks.map(task => (
          <div key={task.id} className="bg-white rounded-2xl p-4 shadow-md border-2 border-yellow-100 flex flex-col sm:flex-row items-center justify-between gap-4">
            <div className="flex items-center gap-4 w-full sm:w-auto">
              <div className="text-5xl bg-blue-50 p-3 rounded-xl">{task.icon}</div>
              <div className="text-xl font-bold text-gray-700">{task.name}</div>
            </div>
            
            <div className="flex items-center gap-2 flex-wrap justify-center">
              {[...Array(task.max)].map((_, i) => (
                <div key={i} className="relative">
                  <Star 
                    size={32} 
                    className={`${i < task.stars ? 'fill-yellow-400 text-yellow-400' : 'text-gray-200'} transition-all duration-300`} 
                  />
                </div>
              ))}
            </div>

            <div className="flex gap-2">
              <button 
                onClick={() => addStar(task.id)}
                disabled={task.stars >= task.max}
                className={`p-3 rounded-xl font-bold text-white shadow-lg active:scale-95 transition ${task.stars >= task.max ? 'bg-gray-300 cursor-not-allowed' : 'bg-green-400 hover:bg-green-500'}`}
              >
                <Check size={24} />
              </button>
              <button 
                onClick={() => resetTask(task.id)}
                className="p-3 rounded-xl bg-red-100 text-red-400 hover:bg-red-200 active:scale-95 transition"
              >
                <RefreshCw size={24} />
              </button>
            </div>
          </div>
        ))}
      </div>
    </div>
  );
};

// --- çµ„ä»¶ï¼šèªçŸ¥å¡ç‰‡ (å­¸ç¿’) ---
const LearnCards = () => {
  const cards = [
    { id: 1, text: 'è²“å’ª', sub: 'Cat', emoji: 'ğŸ±', color: 'bg-orange-100' },
    { id: 2, text: 'ç‹—ç‹—', sub: 'Dog', emoji: 'ğŸ¶', color: 'bg-amber-100' },
    { id: 3, text: 'è˜‹æœ', sub: 'Apple', emoji: 'ğŸ', color: 'bg-red-100' },
    { id: 4, text: 'è»Šè»Š', sub: 'Car', emoji: 'ğŸš—', color: 'bg-blue-100' },
    { id: 5, text: 'å¤ªé™½', sub: 'Sun', emoji: 'â˜€ï¸', color: 'bg-yellow-100' },
    { id: 6, text: 'å¤§è±¡', sub: 'Elephant', emoji: 'ğŸ˜', color: 'bg-gray-100' },
  ];

  const [currentIndex, setCurrentIndex] = useState(0);
  const [isFlipped, setIsFlipped] = useState(false);

  const speak = (text) => {
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = 'zh-TW';
    utterance.rate = 0.8; // è¬›æ…¢ä¸€é»çµ¦å°æœ‹å‹è½
    window.speechSynthesis.speak(utterance);
  };

  const nextCard = () => {
    setIsFlipped(false);
    setTimeout(() => {
      setCurrentIndex((prev) => (prev + 1) % cards.length);
    }, 200);
  };
  
  const prevCard = () => {
    setIsFlipped(false);
    setTimeout(() => {
      setCurrentIndex((prev) => (prev - 1 + cards.length) % cards.length);
    }, 200);
  };

  const currentCard = cards[currentIndex];

  return (
    <div className="flex flex-col items-center justify-center h-full p-4">
      <h2 className="text-3xl font-bold text-blue-600 mb-6 flex items-center gap-2">
        <BookOpen /> èªçŸ¥å¡ç‰‡
      </h2>

      <div className="relative w-full max-w-sm aspect-[3/4] perspective-1000">
        <div 
          onClick={() => {
            setIsFlipped(!isFlipped);
            if(!isFlipped) speak(currentCard.text);
          }}
          className={`w-full h-full transition-transform duration-700 transform-style-3d cursor-pointer relative ${isFlipped ? 'rotate-y-180' : ''}`}
        >
          {/* æ­£é¢ */}
          <div className={`absolute inset-0 backface-hidden ${currentCard.color} rounded-3xl shadow-2xl flex flex-col items-center justify-center border-4 border-white`}>
            <div className="text-9xl animate-bounce-slow mb-8">{currentCard.emoji}</div>
            <div className="text-gray-400 font-bold mt-4">é»æˆ‘ç¿»èƒŒé¢</div>
          </div>

          {/* èƒŒé¢ */}
          <div className={`absolute inset-0 backface-hidden rotate-y-180 bg-white rounded-3xl shadow-2xl flex flex-col items-center justify-center border-4 border-blue-200`}>
            <h3 className="text-6xl font-bold text-gray-800 mb-4">{currentCard.text}</h3>
            <p className="text-3xl text-gray-500 font-sans">{currentCard.sub}</p>
            <button 
              onClick={(e) => {
                e.stopPropagation();
                speak(currentCard.text);
              }}
              className="mt-8 p-4 bg-blue-500 text-white rounded-full shadow-lg hover:bg-blue-600 active:scale-95 transition"
            >
              <Volume2 size={32} />
            </button>
          </div>
        </div>
      </div>

      <div className="flex gap-8 mt-8 w-full max-w-sm justify-between">
        <button onClick={prevCard} className="px-6 py-3 bg-gray-200 rounded-xl font-bold text-gray-600 shadow-md active:scale-95">ä¸Šä¸€å¼µ</button>
        <button onClick={nextCard} className="px-6 py-3 bg-blue-500 rounded-xl font-bold text-white shadow-md active:scale-95">ä¸‹ä¸€å¼µ</button>
      </div>
    </div>
  );
};

// --- çµ„ä»¶ï¼šå°å°ç•«å¸ƒ ---
const DrawingPad = () => {
  const canvasRef = useRef(null);
  const [color, setColor] = useState('#000000');
  const [isDrawing, setIsDrawing] = useState(false);
  const [lineWidth, setLineWidth] = useState(5);

  useEffect(() => {
    const canvas = canvasRef.current;
    const context = canvas.getContext('2d');
    
    // è¨­ç½®ç•«å¸ƒå¤§å°ç‚ºçˆ¶å®¹å™¨å¤§å°
    const setSize = () => {
      const parent = canvas.parentElement;
      if (parent) {
        canvas.width = parent.clientWidth;
        canvas.height = parent.clientHeight;
        context.lineCap = 'round';
        context.lineJoin = 'round';
        context.fillStyle = "#ffffff";
        context.fillRect(0, 0, canvas.width, canvas.height);
      }
    };

    setSize();
    window.addEventListener('resize', setSize);
    return () => window.removeEventListener('resize', setSize);
  }, []);

  const startDrawing = (e) => {
    const canvas = canvasRef.current;
    const context = canvas.getContext('2d');
    const rect = canvas.getBoundingClientRect();
    const x = (e.clientX || e.touches[0].clientX) - rect.left;
    const y = (e.clientY || e.touches[0].clientY) - rect.top;

    context.beginPath();
    context.moveTo(x, y);
    context.strokeStyle = color;
    context.lineWidth = lineWidth;
    setIsDrawing(true);
  };

  const draw = (e) => {
    if (!isDrawing) return;
    const canvas = canvasRef.current;
    const context = canvas.getContext('2d');
    const rect = canvas.getBoundingClientRect();
    const x = (e.clientX || e.touches[0].clientX) - rect.left;
    const y = (e.clientY || e.touches[0].clientY) - rect.top;

    context.lineTo(x, y);
    context.stroke();
  };

  const stopDrawing = () => {
    setIsDrawing(false);
  };

  const clearCanvas = () => {
    const canvas = canvasRef.current;
    const context = canvas.getContext('2d');
    context.fillStyle = "#ffffff";
    context.fillRect(0, 0, canvas.width, canvas.height);
  };

  const colors = ['#ef4444', '#f97316', '#eab308', '#22c55e', '#3b82f6', '#a855f7', '#000000', '#ffffff'];

  return (
    <div className="flex flex-col h-full">
      <div className="bg-pink-100 p-4 flex items-center justify-between shadow-md z-10">
        <h2 className="text-2xl font-bold text-pink-600 flex items-center gap-2">
          <Palette /> å°ç•«å®¶
        </h2>
        <div className="flex gap-2">
          <button onClick={clearCanvas} className="p-2 bg-white text-red-500 rounded-lg shadow hover:bg-red-50">
            <Trash2 />
          </button>
        </div>
      </div>

      <div className="flex-1 relative bg-gray-50 cursor-crosshair touch-none">
        <canvas
          ref={canvasRef}
          className="absolute inset-0 w-full h-full bg-white"
          onMouseDown={startDrawing}
          onMouseMove={draw}
          onMouseUp={stopDrawing}
          onMouseLeave={stopDrawing}
          onTouchStart={startDrawing}
          onTouchMove={draw}
          onTouchEnd={stopDrawing}
        />
      </div>

      <div className="bg-white p-4 flex justify-center items-center gap-4 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] overflow-x-auto">
        {colors.map((c) => (
          <button
            key={c}
            onClick={() => setColor(c)}
            className={`w-10 h-10 rounded-full border-2 flex items-center justify-center transition-transform ${color === c ? 'scale-125 border-gray-400 shadow-lg' : 'border-transparent'}`}
            style={{ backgroundColor: c }}
          >
            {c === '#ffffff' && <div className="text-gray-400 text-xs">æ“¦</div>}
          </button>
        ))}
        <div className="w-px h-8 bg-gray-300 mx-2"></div>
        <div className="flex gap-2">
           <button onClick={() => setLineWidth(5)} className={`w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center ${lineWidth === 5 ? 'ring-2 ring-pink-400' : ''}`}>
             <div className="w-2 h-2 bg-black rounded-full"></div>
           </button>
           <button onClick={() => setLineWidth(15)} className={`w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center ${lineWidth === 15 ? 'ring-2 ring-pink-400' : ''}`}>
             <div className="w-5 h-5 bg-black rounded-full"></div>
           </button>
        </div>
      </div>
    </div>
  );
};

// --- çµ„ä»¶ï¼šå™¹å™¹å°ç«è»Š (æ–°åŠŸèƒ½) ---
const TrainCrossing = () => {
  const [status, setStatus] = useState('idle'); // idle (é–’ç½®), warning (è­¦ç¤ºä¸­), passing (é€šéä¸­)
  const [lightToggle, setLightToggle] = useState(false); // æ§åˆ¶ç´…ç‡ˆé–ƒçˆ

  useEffect(() => {
    let lightInterval;
    let soundInterval;

    if (status === 'warning' || status === 'passing') {
      // ç‡ˆå…‰é–ƒçˆé‚è¼¯
      lightInterval = setInterval(() => {
        setLightToggle(prev => !prev);
      }, 400);

      // è²éŸ³æ’­æ”¾é‚è¼¯ - å™¹å™¹è²
      if (status === 'warning' || status === 'passing') {
          // ç«‹å³æ’­æ”¾ä¸€æ¬¡
          playDangSound();
          soundInterval = setInterval(() => {
             playDangSound();
          }, 800);
      }
    } else {
      setLightToggle(false);
    }

    return () => {
      clearInterval(lightInterval);
      clearInterval(soundInterval);
    };
  }, [status]);

  const playDangSound = () => {
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    const ctx = new AudioContext();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    
    osc.connect(gain);
    gain.connect(ctx.destination);
    
    // æ¨¡æ“¬å™¹å™¹é˜è² (é›™é »ç‡æ··åˆæ›´åƒé‡‘å±¬è²)
    osc.type = 'sine';
    osc.frequency.setValueAtTime(700, ctx.currentTime); 
    gain.gain.setValueAtTime(0.3, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
    
    osc.start();
    osc.stop(ctx.currentTime + 0.5);
  };

  const startTrainSequence = () => {
    if (status !== 'idle') return;

    // 1. é–‹å§‹è­¦ç¤ºï¼ˆå™¹å™¹è² + ç‡ˆå…‰é–ƒçˆ + æŸµæ¬„æ”¾ä¸‹ï¼‰
    setStatus('warning');

    // 2. 3ç§’å¾Œç«è»Šé€šé
    setTimeout(() => {
      setStatus('passing');
      // æ’­æ”¾ç«è»Šè²
      playSound('train-chug');

      // 3. ç«è»Šé€šééœ€è¦4ç§’ï¼Œä¹‹å¾Œé‡ç½®
      setTimeout(() => {
        setStatus('idle');
      }, 4000);
    }, 3000);
  };

  return (
    <div className="flex flex-col h-full bg-sky-200 relative overflow-hidden">
       {/* å¤©ç©ºè£é£¾ */}
       <div className="absolute top-10 left-10 text-yellow-400"><Sun size={64} /></div>
       <div className="absolute top-20 right-20 text-white/50"><i className="cloud" /></div>

       {/* å ´æ™¯å®¹å™¨ */}
       <div className="flex-1 flex flex-col justify-end relative z-10">
          
          {/* èƒŒæ™¯å±±ä¸˜ */}
          <div className="absolute bottom-24 w-full h-32 bg-green-300 rounded-t-[50%] scale-150"></div>

          {/* éµè»Œå€åŸŸ */}
          <div className="h-24 bg-stone-400 w-full relative flex items-center justify-center z-0 mt-auto border-t-8 border-stone-500">
             {/* æ•æœ¨ */}
             <div className="absolute inset-0 flex justify-between px-2">
               {[...Array(20)].map((_,i) => (
                  <div key={i} className="w-4 h-full bg-amber-800/60"></div>
               ))}
             </div>
             {/* é‹¼è»Œ */}
             <div className="absolute top-4 w-full h-2 bg-gray-100"></div>
             <div className="absolute bottom-4 w-full h-2 bg-gray-100"></div>
          </div>

          {/* ç«è»Šå‹•ç•« */}
          <div 
             className={`absolute bottom-28 left-0 transition-transform duration-[4000ms] ease-linear flex items-end z-20
               ${status === 'passing' ? 'translate-x-[150vw]' : '-translate-x-[50vw]'}
             `}
          >
             {/* ç°¡å–® CSS ç«è»Šé ­ */}
             <div className="flex">
                <div className="w-32 h-24 bg-blue-600 rounded-t-2xl rounded-br-xl relative border-4 border-blue-800 flex items-center justify-center">
                   <div className="absolute -top-8 left-4 w-6 h-10 bg-black"></div> {/* ç…™å›ª */}
                   <div className="text-white font-bold text-lg">TOMICA</div>
                   <div className="absolute bottom-2 right-2 w-16 h-8 bg-yellow-300 rounded-full opacity-80"></div>
                </div>
                <div className="w-2 h-8 self-end bg-gray-600"></div>
                <div className="w-32 h-20 bg-blue-500 rounded-t-lg self-end border-4 border-blue-800 relative">
                    <div className="w-full h-1/2 bg-blue-300 border-b-4 border-blue-600 flex gap-2 p-1 justify-center">
                      <div className="w-6 h-full bg-white/50"></div>
                      <div className="w-6 h-full bg-white/50"></div>
                    </div>
                </div>
             </div>
          </div>

          {/* å¹³äº¤é“è™ŸèªŒ (è¸åˆ‡) - å·¦å´ */}
          <div className="absolute bottom-12 left-8 z-30 flex flex-col items-center">
              <div className="w-20 h-20 bg-black/80 rounded-full p-2 flex gap-2 items-center justify-center border-4 border-yellow-400 mb-[-10px] relative shadow-xl">
                 <div className={`w-6 h-6 rounded-full ${lightToggle && status !== 'idle' ? 'bg-red-600 shadow-[0_0_15px_red]' : 'bg-red-900'}`}></div>
                 <div className={`w-6 h-6 rounded-full ${!lightToggle && status !== 'idle' ? 'bg-red-600 shadow-[0_0_15px_red]' : 'bg-red-900'}`}></div>
                 <div className="absolute -top-8 bg-white border-2 border-black px-2 py-1 text-xs font-bold transform -rotate-12 rounded">å¹³äº¤é“</div>
              </div>
              <div className="w-4 h-48 bg-yellow-400 flex flex-col gap-2 items-center py-2 border-x-2 border-black">
                 <div className="w-full h-2 bg-black"></div>
                 <div className="w-full h-2 bg-black"></div>
                 <div className="w-full h-2 bg-black"></div>
                 <div className="w-full h-2 bg-black"></div>
              </div>
          </div>

          {/* é®æ–·æ¡¿ (Bar) */}
          <div className="absolute bottom-28 left-14 z-20 origin-left transition-transform duration-1000"
               style={{ transform: status === 'idle' ? 'rotate(-80deg)' : 'rotate(0deg)' }}>
             <div className="w-64 h-4 bg-yellow-400 border border-black flex relative overflow-hidden rounded-r-full shadow-lg">
                {/* æ–‘é¦¬ç´‹ */}
                <div className="absolute inset-0" style={{ 
                  backgroundImage: 'repeating-linear-gradient(45deg, black 0, black 10px, #fbbf24 10px, #fbbf24 20px)' 
                }}></div>
             </div>
          </div>
       </div>

       {/* æ§åˆ¶å€ */}
       <div className="h-1/3 bg-white p-6 flex flex-col items-center justify-center shadow-[0_-4px_15px_rgba(0,0,0,0.1)] z-40">
          <button 
            onClick={startTrainSequence}
            disabled={status !== 'idle'}
            className={`
              relative w-64 h-24 rounded-full text-3xl font-bold tracking-widest shadow-xl transition-all transform
              ${status === 'idle' 
                ? 'bg-red-500 text-white hover:scale-105 active:scale-95 hover:bg-red-600 border-b-8 border-red-700' 
                : 'bg-gray-300 text-gray-500 cursor-not-allowed border-b-8 border-gray-400'}
            `}
          >
             {status === 'idle' ? 'ğŸš‚ å‡ºç™¼ï¼' : (status === 'warning' ? 'å™¹å™¹å™¹...' : 'ç«è»Šä¾†å›‰ï¼')}
          </button>
          <p className="mt-4 text-gray-500 font-bold">
             {status === 'idle' ? 'é»æ“ŠæŒ‰éˆ•å•Ÿå‹•å¹³äº¤é“' : 'å°å¿ƒç«è»Šé€šéï¼'}
          </p>
       </div>
    </div>
  );
};

// --- å…±ç”¨éŸ³æ•ˆå‡½æ•¸ ---
const playSound = (type) => {
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    const ctx = new AudioContext();
    
    if (type === 'pop') {
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.frequency.setValueAtTime(400, ctx.currentTime);
      osc.frequency.exponentialRampToValueAtTime(600, ctx.currentTime + 0.1);
      gain.gain.setValueAtTime(0.5, ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.1);
      osc.start();
      osc.stop(ctx.currentTime + 0.1);
    } else if (type === 'cheer') {
      [400, 500, 600, 800].forEach((freq, i) => {
        const osc2 = ctx.createOscillator();
        const gain2 = ctx.createGain();
        osc2.connect(gain2);
        gain2.connect(ctx.destination);
        osc2.frequency.value = freq;
        gain2.gain.setValueAtTime(0.2, ctx.currentTime + i*0.1);
        gain2.gain.linearRampToValueAtTime(0, ctx.currentTime + 1);
        osc2.start(ctx.currentTime + i*0.1);
        osc2.stop(ctx.currentTime + 1);
      });
    } else if (type === 'train-chug') {
      // ç°¡å–®çš„ç™½å™ªéŸ³æ¨¡æ“¬ç«è»Šè²
      const bufferSize = ctx.sampleRate * 3; // 3 seconds
      const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
      const data = buffer.getChannelData(0);
      for (let i = 0; i < bufferSize; i++) {
        data[i] = Math.random() * 2 - 1;
      }
      const noise = ctx.createBufferSource();
      noise.buffer = buffer;
      const noiseFilter = ctx.createBiquadFilter();
      noiseFilter.type = 'lowpass';
      noiseFilter.frequency.value = 400;
      const noiseGain = ctx.createGain();
      noiseGain.gain.setValueAtTime(0.1, ctx.currentTime);
      noiseGain.gain.linearRampToValueAtTime(0, ctx.currentTime + 3);
      
      noise.connect(noiseFilter);
      noiseFilter.connect(noiseGain);
      noiseGain.connect(ctx.destination);
      noise.start();
    }
};

// --- ä¸»ç¨‹å¼å…¥å£ ---
export default function App() {
  const [currentView, setCurrentView] = useState('home');

  const renderView = () => {
    switch (currentView) {
      case 'habits':
        return <HabitTracker />;
      case 'learn':
        return <LearnCards />;
      case 'draw':
        return <DrawingPad />;
      case 'train':
        return <TrainCrossing />;
      default:
        return <MainMenu onNavigate={setCurrentView} />;
    }
  };

  return (
    <div className="h-screen w-full bg-slate-50 font-sans overflow-hidden selection:bg-pink-200 text-gray-800">
      <div className="max-w-md mx-auto h-full bg-white shadow-2xl relative flex flex-col md:max-w-full md:rounded-none rounded-none md:w-full">
        
        {/* é ‚éƒ¨å°èˆª (é™¤äº†é¦–é å¤–é¡¯ç¤º) */}
        {currentView !== 'home' && (
          <div className="absolute top-4 left-4 z-50">
            <button 
              onClick={() => setCurrentView('home')}
              className="p-3 bg-white/90 backdrop-blur rounded-full shadow-lg text-indigo-600 hover:bg-indigo-50 transition border-2 border-indigo-100"
            >
              <Home size={28} />
            </button>
          </div>
        )}

        {/* ä¸»è¦å…§å®¹å€ */}
        <main className="flex-1 overflow-hidden relative">
           {renderView()}
        </main>
      </div>
      
      {/* å…¨å±€æ¨£å¼ */}
      <style>{`
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        .perspective-1000 { perspective: 1000px; }
        .animate-bounce-slow { animation: bounce-slow 3s infinite ease-in-out; }
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes bounce-slow { 
          0%, 100% { transform: translateY(-5%); }
          50% { transform: translateY(5%); }
        }
        @keyframes fadeIn {
          from { opacity: 0; transform: scale(0.9); }
          to { opacity: 1; transform: scale(1); }
        }
      `}</style>
    </div>
  );
}